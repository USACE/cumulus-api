<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Processors - Cumulus Geoprocessor</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Processors";
        var mkdocs_page_input_path = "processors/processors.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Cumulus Geoprocessor
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Cumulus Geo-Processing</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../cumulus_geoproc/">Cumulus geoproc</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Geoprocess</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../geoprocess/geoprocess/">Geoprocess</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../geoprocess/hrrr/">High Resolution Rapid Refresh</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../geoprocess/snodas/">Snow Data Assimilation System</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Processors</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Processors</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/boto/">Boto</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/capi/">Capi</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/cgdal/">Cgdal</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Cumulus Geoprocessor</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Cumulus Geo-Processing &raquo;</li>
          <li>Processors &raquo;</li>
      <li>Processors</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors"></a>
  <div class="doc doc-contents first">
  
      <p>Initialize Geo Processor Plugins; source undefined</p>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.cbrfc-mpe"></a>
  <div class="doc doc-contents first">
  
      <h2 id="cumulus_geoproc.processors.cbrfc-mpe--colorado-basin-river-forecast-center-cbrfc">Colorado Basin River Forecast Center (CBRFC)</h2>
<p>Multisensor Precipitation Estimates (MPE)</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.cbrfc-mpe.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/cbrfc-mpe.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncrfc-mpe-01h"></a>
  <div class="doc doc-contents first">
  
      <p>North Central River Forecast Center</p>
<p>Multisensor Precipitation Estimates (MPE)</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncrfc-mpe-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncrfc-mpe-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.lmrfc-qpf-06h"></a>
  <div class="doc doc-contents first">
  
      <p>Lower Mississippi River Forecast Center (LMRFC)</p>
<p>Quantitative Precipitation Estimates (QPF) 6 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.lmrfc-qpf-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/lmrfc-qpf-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-multisensor-qpe-01h-pass1"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass1</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-multisensor-qpe-01h-pass1.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-multisensor-qpe-01h-pass1.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass1&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.nbm-co-01h"></a>
  <div class="doc doc-contents first">
  
      <p>National Blend of Models (NBM)</p>
<p>CONUS 1hour Forecasted Airtemp and QPF</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.nbm-co-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/nbm-co-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="n">filetype_elements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nbm-co-airtemp&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GRIB_SHORT_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;2-HTGL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GRIB_UNIT&quot;</span><span class="p">:</span> <span class="s2">&quot;[C]&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;nbm-co-qpf&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;QPF01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GRIB_SHORT_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;0-SFC&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">filetype_elements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

                <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
                <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
                <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                <span class="p">)</span>

                <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="n">dt_valid_str</span> <span class="o">=</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">dt_valid_str</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                <span class="p">)</span>

                <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                    <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
                    <span class="n">ds</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
                    <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># validate COG</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">filetype</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended Payload: </span><span class="si">{</span><span class="n">outfile_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.serfc-qpf-06h"></a>
  <div class="doc doc-contents first">
  
      <p>South East River Forecast Center</p>
<p>Quantitative Precipitaton Forecast 6 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.serfc-qpf-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/serfc-qpf-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-rtma-ru-anl-airtemp"></a>
  <div class="doc doc-contents first">
  
      <p>NCEP RTMA RU ANL Airtemp</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-rtma-ru-anl-airtemp.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-rtma-ru-anl-airtemp.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.nohrsc-snodas-assimilated"></a>
  <div class="doc doc-contents first">
  
      <p>NOHRSC SNODAS Assimilated</p>
<p>Inside the original assim_layers_YYYYMMDDHH.tar file:
Inside a folder that looks like: ssm1054_2022012212.20220122134004 (without the word 'east')
There is a file that looks like: ssm1054_2022012212.nc.gz
Need to uncompress that NetCDF file</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.nohrsc-snodas-assimilated.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/nohrsc-snodas-assimilated.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">acquirable</span> <span class="o">=</span> <span class="s2">&quot;nohrsc-snodas-swe-corrections&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># extract the member from the tar using this pattern</span>
        <span class="n">member_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;ssm1054_\d+.\d+/ssm1054_\d+.nc.gz&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">member_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>

                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="c1"># decompress the extracted member</span>
                    <span class="n">snodas_assim</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">snodas_assim</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">snodas_assim</span><span class="p">)</span>

                    <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">snodas_assim</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncds</span><span class="p">:</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">]</span>
                        <span class="n">crs</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span>
                        <span class="n">data_vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>

                        <span class="n">valid_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">stop_date</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                            <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                            <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="p">)</span>
                        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>
                        <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>

                        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">yres</span><span class="p">)</span>

                        <span class="n">raster</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
                            <span class="n">tmptif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">snodas_assim</span> <span class="o">+</span> <span class="s2">&quot;.tmp.tif&quot;</span><span class="p">),</span>
                            <span class="n">xsize</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                            <span class="n">ysize</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                            <span class="n">bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">eType</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">raster</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>
                        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>

                        <span class="c1"># srs.ImportFromEPSG(4326)</span>
                        <span class="n">srs</span><span class="o">.</span><span class="n">SetWellKnownGeogCS</span><span class="p">(</span><span class="n">crs</span><span class="o">.</span><span class="n">horizontal_datum</span><span class="p">)</span>

                        <span class="n">raster</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
                        <span class="n">band</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                        <span class="c1"># Reference the following for reason to flip</span>
                        <span class="c1"># https://www.unidata.ucar.edu/support/help/MailArchives/netcdf/msg03585.html</span>
                        <span class="c1"># Basically, get the array sequence like other Tiffs</span>
                        <span class="n">data_vals</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span>
                        <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data_vals</span><span class="p">)</span>
                        <span class="n">raster</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
                        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
                            <span class="n">tmptif</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">noData</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">no_data_value</span><span class="p">,</span>
                            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                            <span class="p">],</span>
                        <span class="p">)</span>

                        <span class="c1"># validate COG</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                        <span class="c1"># Append dictionary object to outfile list</span>
                        <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="s2">&quot;nohrsc-snodas-swe-corrections&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">valid_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Outfile Append: </span><span class="si">{</span><span class="n">outfile_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-ppt-stable"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily (D2) total precipitation (ppt)(rain+melted snow)</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-ppt-stable.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-ppt-stable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.nohrsc-snodas-unmasked"></a>
  <div class="doc doc-contents first">
  
      <p>NOHRSC SNODAS Unmasked</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.nohrsc-snodas-unmasked.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/nohrsc-snodas-unmasked.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">paramater_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1034&quot;</span><span class="p">,</span> <span class="s2">&quot;1036&quot;</span><span class="p">,</span> <span class="s2">&quot;1038&quot;</span><span class="p">,</span> <span class="s2">&quot;1044&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># download tar to destination (temporary directory)</span>
        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># decompress the tar and gzip files in the tar</span>
        <span class="n">decompressed_files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">decompressed_files</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a directory: </span><span class="si">{</span><span class="n">decompressed_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># generator for only the files ending with .txt</span>
        <span class="n">txt_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">decompressed_files</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">))</span>

        <span class="n">translate_to_tif</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># create tif files for only the files needed</span>
        <span class="k">for</span> <span class="n">txt_file</span> <span class="ow">in</span> <span class="n">txt_files</span><span class="p">:</span>
            <span class="n">snodas_product_code</span> <span class="o">=</span> <span class="n">txt_file</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">snodas_product_code</span> <span class="ow">in</span> <span class="n">paramater_codes</span><span class="p">:</span>
                <span class="n">fqpn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decompressed_files</span><span class="p">,</span> <span class="n">txt_file</span><span class="p">)</span>
                <span class="n">meta_ntuple</span> <span class="o">=</span> <span class="n">metaparse</span><span class="o">.</span><span class="n">to_namedtuple</span><span class="p">(</span><span class="n">fqpn</span><span class="p">)</span>
                <span class="n">data_filename</span> <span class="o">=</span> <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">data_file_pathname</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">txt_file</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">stop_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_year</span><span class="p">,</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_month</span><span class="p">,</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_day</span><span class="p">,</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_hour</span><span class="p">,</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_minute</span><span class="p">,</span>
                    <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">stop_second</span><span class="p">,</span>
                    <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># FQPN to data file</span>
                <span class="n">datafile_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decompressed_files</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data File Path: </span><span class="si">{</span><span class="n">datafile_pathname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># write hdr so gdal can tranlate</span>
                <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">metaparse</span><span class="o">.</span><span class="n">write_hdr</span><span class="p">(</span>
                    <span class="n">fqpn</span><span class="p">,</span> <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">number_of_columns</span><span class="p">,</span> <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">number_of_rows</span>
                <span class="p">)</span>
                <span class="c1"># translate to tif</span>
                <span class="k">if</span> <span class="n">hdr_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># set translate options</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">datafile_pathname</span><span class="p">)</span>

                    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                        <span class="n">tif</span> <span class="o">:=</span> <span class="n">file_extension</span><span class="p">(</span><span class="n">datafile_pathname</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">),</span>
                        <span class="n">ds</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                        <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">outputSRS</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;+proj=longlat +ellps=</span><span class="si">{</span><span class="n">meta_ntuple</span><span class="o">.</span><span class="n">horizontal_datum</span><span class="si">}</span><span class="s2"> +datum=</span><span class="si">{</span><span class="n">meta_ntuple</span><span class="o">.</span><span class="n">horizontal_datum</span><span class="si">}</span><span class="s2"> +no_defs&quot;</span><span class="p">,</span>
                        <span class="n">noData</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">meta_ntuple</span><span class="o">.</span><span class="n">no_data_value</span><span class="p">),</span>
                        <span class="n">outputBounds</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">minimum_x_axis_coordinate</span><span class="p">,</span>
                            <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">maximum_y_axis_coordinate</span><span class="p">,</span>
                            <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">maximum_x_axis_coordinate</span><span class="p">,</span>
                            <span class="n">meta_ntuple</span><span class="o">.</span><span class="n">minimum_y_axis_coordinate</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                            <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">)</span>

                    <span class="c1"># validate COG</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                    <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># add tif dictionary to compute cold content</span>
                    <span class="n">translate_to_tif</span><span class="p">[</span><span class="n">snodas_product_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                        <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">snodas</span><span class="o">.</span><span class="n">product_code</span><span class="p">[</span><span class="n">snodas_product_code</span><span class="p">][</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">stop_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update Tif: </span><span class="si">{</span><span class="n">translate_to_tif</span><span class="p">[</span><span class="n">snodas_product_code</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># cold content = swe * 2114 * snowtemp (degc) / 333000</span>
        <span class="c1"># id 2072</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">:=</span> <span class="n">snodas</span><span class="o">.</span><span class="n">cold_content</span><span class="p">(</span><span class="n">translate_to_tif</span><span class="p">):</span>
            <span class="n">translate_to_tif</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cold content product computed and dictionary updated&quot;</span><span class="p">)</span>

        <span class="c1"># convert snow melt to mm</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">:=</span> <span class="n">snodas</span><span class="o">.</span><span class="n">snow_melt_mm</span><span class="p">(</span><span class="n">translate_to_tif</span><span class="p">):</span>
            <span class="n">translate_to_tif</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="c1"># remove snowmelt with unit meters and scale factor 100_000</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">translate_to_tif</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;1044&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Snow melt product conversion and original popped from dictionary&quot;</span>
            <span class="p">)</span>

        <span class="n">outfile_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">translate_to_tif</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-ppt-early"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily (D2) total precipitation (ppt)(rain+melted snow)</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-ppt-early.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-ppt-early.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ndgd-ltia98-airtemp"></a>
  <div class="doc doc-contents first">
  
      <p>NDGD LEIA98 Precipitation</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ndgd-ltia98-airtemp.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ndgd-ltia98-airtemp.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.naefs-mean-06h"></a>
  <div class="doc doc-contents first">
  
      <p>NAEFS Mean 6 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.naefs-mean-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/naefs-mean-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="n">products</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;QPF&quot;</span><span class="p">:</span> <span class="s2">&quot;naefs-mean-qpf-06h&quot;</span><span class="p">,</span> <span class="s2">&quot;QTF&quot;</span><span class="p">:</span> <span class="s2">&quot;naefs-mean-qtf-06h&quot;</span><span class="p">}</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncds</span><span class="p">:</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d</span><span class="si">{4}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2"> \d+:\d+:\d+&quot;</span><span class="p">,</span> <span class="n">ncds</span><span class="o">.</span><span class="n">date_created</span><span class="p">)</span>
            <span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">time_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
            <span class="p">)</span>

            <span class="n">lat</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][:]</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][:]</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">wkt</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">crs_wkt</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WKT: </span><span class="si">{</span><span class="n">wkt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">nctime</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">acquirable_</span> <span class="ow">in</span> <span class="n">products</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Product Variable: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Product Acquirable: </span><span class="si">{</span><span class="n">acquirable_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ncvar</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">nodata</span> <span class="o">=</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">_FillValue</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">shape</span>

                <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>
                <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>
                <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">yres</span><span class="p">)</span>

                <span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">num2date</span><span class="p">(</span>
                    <span class="n">nctime</span><span class="p">[:],</span> <span class="n">nctime</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">only_use_cftime_datetimes</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">):</span>
                    <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">date2index</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">nctime</span><span class="p">)</span>
                    <span class="n">nctime_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span>

                    <span class="n">raster</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
                        <span class="n">tmptif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">dst</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">nctime_str</span><span class="si">}</span><span class="s2">-tmp.tif&quot;</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">xsize</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                        <span class="n">ysize</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                        <span class="n">bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">eType</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>
                    <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
                    <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>

                    <span class="n">raster</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
                    <span class="n">band</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Reference the following for reason to flip</span>
                    <span class="c1"># https://www.unidata.ucar.edu/support/help/MailArchives/netcdf/msg03585.html</span>
                    <span class="c1"># Basically, get the array sequence like other Tiffs</span>
                    <span class="n">_data</span> <span class="o">=</span> <span class="n">ncvar</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
                    <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
                    <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                        <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tmptif</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-tmp.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)),</span>
                        <span class="n">tmptif</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                        <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">noData</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span>
                        <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                            <span class="s2">&quot;RESAMPLING=BILINEAR&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEW_RESAMPLING=BILINEAR&quot;</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">)</span>

                    <span class="c1"># validate COG</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                    <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable_</span><span class="p">,</span>
                            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">date_created</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.marfc-nbmt-03h"></a>
  <div class="doc doc-contents first">
  
      <p>Middle Atlantic River Forecast Center</p>
<p>National Blend of Models Surface Temperature 3 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.marfc-nbmt-03h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/marfc-nbmt-03h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p2-carib"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass2 Carib</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p2-carib.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-msqpe01h-p2-carib.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass2&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.marfc-rtmat-01h"></a>
  <div class="doc doc-contents first">
  
      <p>Middle Atlantic River Forecast Center</p>
<p>Real Time Mesoscale Analysis Surface Temperature as Observed</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.marfc-rtmat-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/marfc-rtmat-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncrfc-rtmat-01h"></a>
  <div class="doc doc-contents first">
  
      <p>North Central River Forecast Center</p>
<p>Multisensor Precipitation Estimates (MPE)</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncrfc-rtmat-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncrfc-rtmat-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.marfc-nbmt-01h"></a>
  <div class="doc doc-contents first">
  
      <p>Middle Atlantic River Forecast Center</p>
<p>National Blend of Models Surface Temperature 1 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.marfc-nbmt-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/marfc-nbmt-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncrfc-fmat-01h"></a>
  <div class="doc doc-contents first">
  
      <p>North Central River Forecast Center</p>
<p>Forecast Mesoscale Analysis Surface Temperature 01Hr</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncrfc-fmat-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncrfc-fmat-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">grib</span> <span class="ow">in</span> <span class="n">gdal</span><span class="o">.</span><span class="n">ReadDir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/vsitar/</span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">grib</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/vsitar/</span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">grib</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Compile regex to get times from timestamp</span>
                <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>

                <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">valid_time</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">valid_time_match</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">ref_time</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ref_time_match</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                    <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
                    <span class="n">ds</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># Append dictionary object to outfile list</span>
                <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">valid_time</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">ref_time</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.nsidc-ua-swe-sd-v1"></a>
  <div class="doc doc-contents first">
  
      <p>NSIDC SWE v1</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.nsidc-ua-swe-sd-v1.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/nsidc-ua-swe-sd-v1.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Variables and their product slug</span>
    <span class="n">nc_variables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;SWE&quot;</span><span class="p">:</span> <span class="s2">&quot;nsidc-ua-swe-v1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEPTH&quot;</span><span class="p">:</span> <span class="s2">&quot;nsidc-ua-snowdepth-v1&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nc_variable</span><span class="p">,</span> <span class="n">nc_slug</span> <span class="ow">in</span> <span class="n">nc_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NETCDF:</span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">nc_variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># set the start time</span>
            <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+ \w+ (\d</span><span class="si">{4}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">day_since_str</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;time#units&quot;</span><span class="p">))</span>
            <span class="n">day_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">day_since_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">band_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># set the bands date</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>
                <span class="n">delta_days</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;NETCDF_DIM_time&quot;</span><span class="p">)</span>
                <span class="n">band_date</span> <span class="o">=</span> <span class="n">day_since</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">delta_days</span><span class="p">))</span>

                <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">band_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">datetime_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nc_variable</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                <span class="p">)</span>

                <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                    <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
                    <span class="n">ds</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
                    <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># validate COG</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">nc_slug</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">band_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.wpc-qpf-2p5km"></a>
  <div class="doc doc-contents first">
  
      <p>WPC QPF 2.5km</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.wpc-qpf-2p5km.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/wpc-qpf-2p5km.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP06&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-tmin-stable"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily minimum temperature [averaged over all days in the month]</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-tmin-stable.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-tmin-stable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ndgd-leia98-precip"></a>
  <div class="doc doc-contents first">
  
      <p>NDGD LEIA98 Precipitation</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ndgd-leia98-precip.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ndgd-leia98-precip.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.wrf-columbia-airtemp"></a>
  <div class="doc doc-contents first">
  
      <p>WRF Columbia Airtemp</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.wrf-columbia-airtemp.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
        <tr>
          <td>
                <code>acquirable</code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/wrf-columbia-airtemp.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    acquirable = &quot;wrf-columbia-airtemp&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ncds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ncds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;var&quot;</span><span class="p">][:]</span>
        <span class="n">time_</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+ \w+ (\d</span><span class="si">{4}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2"> \d+:\d+:\d+)&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">since_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">time_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">nctimes</span> <span class="o">=</span> <span class="p">(</span><span class="n">since_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">td</span><span class="p">))</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">time_</span><span class="p">)</span>

        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nctime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nctimes</span><span class="p">):</span>
            <span class="n">bandx</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nctime_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">nctime</span><span class="p">,</span> <span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_T%H_%M&quot;</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">bandx</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>

            <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">yres</span><span class="p">)</span>

            <span class="n">raster</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
                <span class="n">tmptif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">nctime_str</span><span class="si">}</span><span class="s2">.tmp.tif&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">xsize</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                <span class="n">ysize</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                <span class="n">bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">eType</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">raster</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>
            <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>

            <span class="n">raster</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Reference the following for reason to flip</span>
            <span class="c1"># https://www.unidata.ucar.edu/support/help/MailArchives/netcdf/msg03585.html</span>
            <span class="c1"># Basically, get the array sequence like other Tiffs</span>
            <span class="n">bandx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">bandx</span><span class="p">)</span>
            <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">bandx</span><span class="p">)</span>
            <span class="n">raster</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
            <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cgdal</span><span class="o">.</span><span class="n">gdal_translate_w_overviews</span><span class="p">(</span>
                <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">nctime_str</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)),</span>
                <span class="n">tmptif</span><span class="p">,</span>
                <span class="n">translate_options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bandList&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;outputBounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">337997.806</span><span class="p">,</span> <span class="mf">812645.371</span><span class="p">,</span> <span class="mf">854002.194</span><span class="p">,</span> <span class="o">-</span><span class="mf">535354.629</span><span class="p">],</span>
                    <span class="s2">&quot;outputSRS&quot;</span><span class="p">:</span> <span class="s2">&quot;+proj=lcc +lat_1=45 +lat_2=45 +lon_0=-120 +lat_0=45.80369 +x_0=0 +y_0=0 +a=6370000 +b=6370000 +units=m&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;creationOptions&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># validate COG</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmptif</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

            <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">nctime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncds</span><span class="p">:</span>
            <span class="n">ncds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p2-alaska"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass2 Alaska</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p2-alaska.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-msqpe01h-p2-alaska.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass2&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.mbrfc-krf-qpe-01h"></a>
  <div class="doc doc-contents first">
  
      <p>Missouri Basin River Forecast Center</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.mbrfc-krf-qpe-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/mbrfc-krf-qpe-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-tmax-early"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily (D2) maximum temperature (tmax) [averaged over all days in the month]</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-tmax-early.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-tmax-early.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ndfd-conus-airtemp"></a>
  <div class="doc doc-contents first">
  
      <p>NDFD CONUS Airtemp</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ndfd-conus-airtemp.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ndfd-conus-airtemp.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">filename_temp</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{filename}</span><span class="s2">-$</span><span class="si">{ymd}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

        <span class="c1"># Create a dictionary of time deltas and equivalent filetype</span>
        <span class="n">f_type_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">3600</span><span class="p">:</span> <span class="s2">&quot;ndfd-conus-airtemp-01h&quot;</span><span class="p">,</span>
            <span class="mi">10800</span><span class="p">:</span> <span class="s2">&quot;ndfd-conus-airtemp-03h&quot;</span><span class="p">,</span>
            <span class="mi">21600</span><span class="p">:</span> <span class="s2">&quot;ndfd-conus-airtemp-06h&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">tdelta2</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">band_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tdelta1</span> <span class="o">=</span> <span class="n">tdelta2</span>

                <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

                <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">vtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">rtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="n">forcast_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_FORECAST_SECONDS&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">forcast_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">forcast_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Check the time deltas to see if they are consistant</span>
                <span class="n">tdelta2</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">forcast_time</span><span class="p">)</span>
                <span class="n">tdelta</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdelta2</span> <span class="o">-</span> <span class="n">tdelta1</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>  <span class="c1"># Extract Band; Convert to COG</span>

                <span class="k">if</span> <span class="n">tdelta</span> <span class="ow">in</span> <span class="n">f_type_dict</span><span class="p">:</span>
                    <span class="n">_filename</span> <span class="o">=</span> <span class="n">filename_temp</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">filename_</span><span class="p">,</span> <span class="n">ymd</span><span class="o">=</span><span class="n">vtime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New Filename: </span><span class="si">{</span><span class="n">_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                        <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">_filename</span><span class="p">),</span>
                        <span class="n">ds</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                        <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
                        <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                            <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">)</span>

                    <span class="c1"># validate COG</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                    <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">f_type_dict</span><span class="p">[</span><span class="n">tdelta</span><span class="p">],</span>
                            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">vtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">rtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-tmax-stable"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily (D2) maximum temperature (tmax) [averaged over all days in the month]</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-tmax-stable.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-tmax-stable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.lmrfc-qpe-01h"></a>
  <div class="doc doc-contents first">
  
      <p>Lower Mississippi River Forecast Center (LMRFC)</p>
<p>Quantitative Precipitation Estimates (QPE) 1 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.lmrfc-qpe-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/lmrfc-qpe-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-gaugecorr-qpe-01h"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS Gauge Corrected</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-gaugecorr-qpe-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-gaugecorr-qpe-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;GaugeCorrected_QPE_01H&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.serfc-qpe-01h"></a>
  <div class="doc doc-contents first">
  
      <p>South East River Forecast Center</p>
<p>Quantitative Precipitation Estimates (QPE) 1 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.serfc-qpe-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/serfc-qpe-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ndfd-conus-qpf-06h"></a>
  <div class="doc doc-contents first">
  
      <p>NDFD CONUS QPF 6 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ndfd-conus-qpf-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ndfd-conus-qpf-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">filename_temp</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{filename}</span><span class="s2">-$</span><span class="si">{ymd}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterCount</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">band_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

                <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">vtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">rtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                <span class="n">_filename</span> <span class="o">=</span> <span class="n">filename_temp</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">filename_</span><span class="p">,</span> <span class="n">ymd</span><span class="o">=</span><span class="n">vtime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New Filename: </span><span class="si">{</span><span class="n">_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
                    <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">_filename</span><span class="p">),</span>
                    <span class="n">ds</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
                    <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># validate COG</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

                <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                        <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">vtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">rtime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.marfc-fmat-06h"></a>
  <div class="doc doc-contents first">
  
      <p>Middle Atlantic River Forecast Center (MARFC)</p>
<p>Forecast Mesoscale Analysis Temperature, Air 6 hour</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.marfc-fmat-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/marfc-fmat-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p1-alaska"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass1 Alaska</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p1-alaska.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-msqpe01h-p1-alaska.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass1&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.hrrr-total-precip"></a>
  <div class="doc doc-contents first">
  
      <p>High Resolution Rapid Refresh (HRRR) Total Precipitation</p>
<p>HRRR file source:
    https://nomads.ncep.noaa.gov/pub/data/nccf/com/hrrr/prod/</p>
<p>2022-04-29 Update:
    HRRR index files (hrrr_filename.grib2.idx) are used to determine the
    ever changing '01 hr Total Precipitation' raster band number.  Archived
    HRRR products do not have idx files saved in S3, so this processor
    tries to account for that.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.hrrr-total-precip.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/hrrr-total-precip.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GRIB_COMMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GRIB_UNIT&quot;</span><span class="p">:</span> <span class="s2">&quot;[kg/(m^2)]&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># open the hrrr.grib2 file</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_</span><span class="p">)</span>

        <span class="c1"># Successful download means we have the idx we need</span>
        <span class="n">idx_file</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.idx&quot;</span>

        <span class="k">if</span> <span class="n">hrrridx</span> <span class="o">:=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">idx_file</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">hrrr</span><span class="o">.</span><span class="n">HrrrIdx</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hrrridx</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="n">idx</span><span class="o">.</span><span class="n">linex</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1"># This if statement means Total Precip for 01 hr forecast</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="s2">&quot;APCP&quot;</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">idx</span><span class="o">.</span><span class="n">forecast_hour</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span><span class="o">.</span><span class="n">forecast_hour</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="n">band_number</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">raster_band</span>
            <span class="k">if</span> <span class="n">band_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found in idx: </span><span class="si">{hrrridx}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found in </span><span class="si">{</span><span class="n">hrrridx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.wrf-columbia-precip"></a>
  <div class="doc doc-contents first">
  
      <p>WRF Columbia Precipitation</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.wrf-columbia-precip.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
        <tr>
          <td>
                <code>acquirable</code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/wrf-columbia-precip.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    acquirable = &quot;wrf-columbia-precip&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ncds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ncds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;var&quot;</span><span class="p">][:]</span>
        <span class="n">time_</span> <span class="o">=</span> <span class="n">ncds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+ \w+ (\d</span><span class="si">{4}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2"> \d+:\d+:\d+)&quot;</span><span class="p">)</span>
        <span class="n">time_str</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">time_</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">since_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">time_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">nctimes</span> <span class="o">=</span> <span class="p">(</span><span class="n">since_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">td</span><span class="p">))</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">time_</span><span class="p">)</span>

        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nctime</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nctimes</span><span class="p">):</span>
            <span class="n">bandx</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nctime_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">nctime</span><span class="p">,</span> <span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_T%H_%M&quot;</span><span class="p">)</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">bandx</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>

            <span class="n">geotransform</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">yres</span><span class="p">)</span>

            <span class="n">raster</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;GTiff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
                <span class="n">tmptif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">nctime_str</span><span class="si">}</span><span class="s2">.tmp.tif&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">xsize</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                <span class="n">ysize</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                <span class="n">bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">eType</span><span class="o">=</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">raster</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>
            <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>

            <span class="n">raster</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Reference the following for reason to flip</span>
            <span class="c1"># https://www.unidata.ucar.edu/support/help/MailArchives/netcdf/msg03585.html</span>
            <span class="c1"># Basically, get the array sequence like other Tiffs</span>
            <span class="n">bandx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">bandx</span><span class="p">)</span>
            <span class="n">band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">bandx</span><span class="p">)</span>
            <span class="n">raster</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>
            <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cgdal</span><span class="o">.</span><span class="n">gdal_translate_w_overviews</span><span class="p">(</span>
                <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">nctime_str</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)),</span>
                <span class="n">tmptif</span><span class="p">,</span>
                <span class="n">translate_options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;bandList&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;outputBounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">337997.806</span><span class="p">,</span> <span class="mf">812645.371</span><span class="p">,</span> <span class="mf">854002.194</span><span class="p">,</span> <span class="o">-</span><span class="mf">535354.629</span><span class="p">],</span>
                    <span class="s2">&quot;outputSRS&quot;</span><span class="p">:</span> <span class="s2">&quot;+proj=lcc +lat_1=45 +lat_2=45 +lon_0=-120 +lat_0=45.80369 +x_0=0 +y_0=0 +a=6370000 +b=6370000 +units=m&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;creationOptions&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># validate COG</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmptif</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

            <span class="n">outfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">nctime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncds</span><span class="p">:</span>
            <span class="n">ncds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.prism-tmin-early"></a>
  <div class="doc doc-contents first">
  
      <p>PRISM Climate Group</p>
<p>Daily minimum temperature [averaged over all days in the month]</p>
<p>Reference: https://www.prism.oregonstate.edu/documents/PRISM_datasets.pdf</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.prism-tmin-early.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/prism-tmin-early.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outfile_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># download the file to the current filesystem and extract</span>
        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">file_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">src_</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract from zip: </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get date from filename like PRISM_ppt_early_4kmD2_yyyyMMdd_bil.zip</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+_(?P&lt;ymd&gt;\d+)_\w+&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;ymd&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
        <span class="p">)</span>

        <span class="n">src_bil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bil&quot;</span><span class="p">))</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">src_bil</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.mbrfc-krf-fct-airtemp-01h"></a>
  <div class="doc doc-contents first">
  
      <p>Missouri Basin River Forecast Center</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.mbrfc-krf-fct-airtemp-01h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/mbrfc-krf-fct-airtemp-01h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;TMP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-multisensor-qpe-01h-pass2"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass2</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-multisensor-qpe-01h-pass2.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-multisensor-qpe-01h-pass2.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass2&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p1-carib"></a>
  <div class="doc doc-contents first">
  
      <p>MRMS MultiSensor QPE 01H Pass1 Carib</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.ncep-mrms-v12-msqpe01h-p1-carib.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/ncep-mrms-v12-msqpe01h-p1-carib.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;MultiSensor_QPE_01H_Pass1&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NUM_THREADS=ALL_CPUS&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># validate COG</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validate</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">validate_cog</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">tif</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validate COG = </span><span class="si">{</span><span class="n">validate</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">tif</span><span class="si">}</span><span class="s2"> is a COG&quot;</span><span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># closing the data source</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="cumulus_geoproc.processors.mbrfc-krf-qpf-06h"></a>
  <div class="doc doc-contents first">
  
      <p>Missouri Basin River Forecast Center</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="cumulus_geoproc.processors.mbrfc-krf-qpf-06h.process" class="doc doc-heading">
<code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">acquirable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Grid processor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to input file for processing</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>path to temporary directory created from worker thread</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>acquirable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>acquirable slug</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>List[dict]</code>
          </td>
          <td><p>{
"filetype": str,         Matching database acquirable
"file": str,             Converted file
"datetime": str,         Valid Time, ISO format with timezone
"version": str           Reference Time (forecast), ISO format with timezone
}</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>cumulus_geoproc/processors/mbrfc-krf-qpf-06h.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@pyplugs</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">acquirable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid processor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        path to input file for processing</span>
<span class="sd">    dst : str</span>
<span class="sd">        path to temporary directory created from worker thread</span>
<span class="sd">    acquirable: str</span>
<span class="sd">        acquirable slug</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[dict]</span>
<span class="sd">        {</span>
<span class="sd">            &quot;filetype&quot;: str,         Matching database acquirable</span>
<span class="sd">            &quot;file&quot;: str,             Converted file</span>
<span class="sd">            &quot;datetime&quot;: str,         Valid Time, ISO format with timezone</span>
<span class="sd">            &quot;version&quot;: str           Reference Time (forecast), ISO format with timezone</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;GRIB_ELEMENT&quot;</span><span class="p">:</span> <span class="s2">&quot;APCP&quot;</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">filename_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3_download_file(</span><span class="si">{</span><span class="n">bucket</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">key</span><span class="si">=}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">src_</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">s3_download_file</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S3 Downloaded File: </span><span class="si">{</span><span class="n">src_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;/vsigzip/&quot;</span> <span class="o">+</span> <span class="n">src_</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">band_number</span> <span class="o">:=</span> <span class="n">cgdal</span><span class="o">.</span><span class="n">find_band</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Band number not found for attributes: </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Band number &#39;</span><span class="si">{</span><span class="n">band_number</span><span class="si">}</span><span class="s2">&#39; found for attributes </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">band_number</span><span class="p">)</span>

        <span class="c1"># Get Datetime from String Like &quot;1599008400 sec UTC&quot;</span>
        <span class="n">time_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">)</span>
        <span class="n">valid_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_VALID_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valid_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">ref_time_match</span> <span class="o">=</span> <span class="n">time_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">GetMetadataItem</span><span class="p">(</span><span class="s2">&quot;GRIB_REF_TIME&quot;</span><span class="p">))</span>
        <span class="n">dt_ref</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ref_time_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">gdal</span><span class="o">.</span><span class="n">Translate</span><span class="p">(</span>
            <span class="n">tif</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename_</span><span class="p">),</span>
            <span class="n">ds</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
            <span class="n">bandList</span><span class="o">=</span><span class="p">[</span><span class="n">band_number</span><span class="p">],</span>
            <span class="n">creationOptions</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEWS=IGNORE_EXISTING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;OVERVIEW_RESAMPLING=AVERAGE&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">outfile_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;filetype&quot;</span><span class="p">:</span> <span class="n">acquirable</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">tif</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt_valid</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">dt_ref</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">this</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outfile_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../geoprocess/snodas/" class="btn btn-neutral float-left" title="Snow Data Assimilation System"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../utils/boto/" class="btn btn-neutral float-right" title="Boto">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../geoprocess/snodas/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../utils/boto/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
